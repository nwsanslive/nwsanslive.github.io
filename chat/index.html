<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        body {background-color:#121212;color:#e0e0e0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;}
        #header {height:56px;background:#1e1e1e;display:flex;align-items:center;padding:0 16px;font-size:18px;font-weight:bold;border-bottom:1px solid #333;flex-shrink:0;}
        .status {text-align:center;padding:6px;font-size:13px;color:#aaa;flex-shrink:0;}
        #messages {flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
        .message {max-width:75%;padding:11px 16px;border-radius:20px;word-wrap:break-word;white-space:pre-wrap;line-height:1.5;font-size:16px;position:relative;}
        .sent {align-self:flex-end;background:#95EC69;color:#000;}
        .received {align-self:flex-start;background:#ffffff;color:#000;}
        .media-img {max-width:100%;border-radius:12px;margin-top:8px;cursor:pointer;}
        .media-video {max-width:100%;border-radius:12px;margin-top:8px;}
        .file-link {color:#5ebff9;text-decoration:underline;margin-top:8px;display:block;font-size:15px;}
        #input-area {flex-shrink:0;display:flex;align-items:center;padding:10px 15px;background:#1e1e1e;padding-bottom:calc(env(safe-area-inset-bottom)+10px);}
        #message-input {flex:1;height:44px;padding:0 16px;border:none;border-radius:22px;background:#333333;color:#fff;font-size:16px;}
        #message-input:focus {outline:none;}
        #attach-button, #send-button {
            margin-left:10px;width:44px;height:44px;background:#95EC69;color:#000;border:none;border-radius:22px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;}
        #role-selection {flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#1e1e1e;}
        #role-selection button {margin:15px;padding:14px 32px;font-size:18px;background:#95EC69;color:#000;border:none;border-radius:12px;cursor:pointer;}
        #file-input {display:none;}

        /* 全屏图片查看器 */
        #fullscreen-overlay {
            display:none;
            position:fixed;
            top:0;left:0;right:0;bottom:0;
            background:rgba(0,0,0,0.9);
            align-items:center;
            justify-content:center;
            z-index:9999;
        }
        #fullscreen-img {
            max-width:95%;
            max-height:95%;
            border-radius:8px;
        }
    </style>
</head>
<body>

    <div id="role-selection">
        <h1>Chat</h1>
        <p>选择你的身份</p>
        <button onclick="selectRole('弟弟')">弟弟</button>
        <button onclick="selectRole('哥哥')">哥哥</button>
    </div>

    <div id="chat-container" style="display:none;flex-direction:column;height:100vh;">
        <div id="header">Chat</div>
        <div class="status" id="status">正在加载...</div>
        <div id="messages"></div>
        <div id="input-area">
            <button id="attach-button" title="添加附件">+</button>
            <input type="text" id="message-input" placeholder="输入消息...">
            <button id="send-button">发送</button>
            <input type="file" id="file-input" accept="*/*" multiple>
        </div>
    </div>

    <!-- 全屏图片查看器 -->
    <div id="fullscreen-overlay">
        <img id="fullscreen-img" src="" alt="全屏图片">
    </div>

    <script>
        const REPO = 'nwsanslive/nwsanslive.github.io';
        const HISTORY_PATH = 'chat/chat-history.json';
        const FILES_FOLDER = 'chat/files';
        const BRANCH = 'main';

        const HISTORY_API = `https://api.github.com/repos/${REPO}/contents/${HISTORY_PATH}`;
        const urlParams = new URLSearchParams(window.location.search);
        const GITHUB_TOKEN = urlParams.get('token');

        let currentRole = null;
        const messagesDiv = document.getElementById('messages');
        const chatContainer = document.getElementById('chat-container');
        const roleSelection = document.getElementById('role-selection');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        const header = document.getElementById('header');

        // 全屏图片相关
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const fullscreenImg = document.getElementById('fullscreen-img');

        if (!GITHUB_TOKEN || !GITHUB_TOKEN.startsWith('ghp_')) {
            document.body.innerHTML = `<div style="padding:50px;text-align:center;color:#fff;"><h2>缺少 Token</h2><p>请使用带 ?token= 的链接</p></div>`;
            throw new Error("No token");
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 点击图片放大
        function addImageClickListener(img) {
            img.onclick = () => {
                fullscreenImg.src = img.src;
                fullscreenOverlay.style.display = 'flex';
            };
        }

        // 关闭全屏图片
        fullscreenOverlay.onclick = () => {
            fullscreenOverlay.style.display = 'none';
        };

        async function loadMessages() {
            try {
                const res = await fetch(HISTORY_API, {headers: {'Authorization': `token ${GITHUB_TOKEN}`}});
                if (res.status === 404) {
                    await createEmptyHistory();
                    renderMessages([]);
                    statusDiv.textContent = '新聊天已开始';
                    return;
                }
                const data = await res.json();
                const history = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                renderMessages(history);
                statusDiv.textContent = '记录已同步';
                scrollToBottom();
            } catch (e) {
                statusDiv.textContent = '加载失败';
            }
        }

        async function createEmptyHistory() {
            await fetch(HISTORY_API, {
                method: 'PUT',
                headers: {'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json'},
                body: JSON.stringify({message: 'init', content: btoa('[]'), branch: BRANCH})
            });
        }

        function renderMessages(history) {
            messagesDiv.innerHTML = '';
            history.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('message', item.role === currentRole ? 'sent' : 'received');

                if (item.type === 'text') {
                    div.textContent = item.content;
                } else if (item.type === 'image') {
                    const img = document.createElement('img');
                    img.src = item.url;
                    img.className = 'media-img';
                    addImageClickListener(img);  // 添加点击放大
                    div.appendChild(img);
                } else if (item.type === 'video') {
                    const video = document.createElement('video');
                    video.src = item.url;
                    video.controls = true;
                    video.className = 'media-video';
                    div.appendChild(video);
                } else { // file
                    // 只显示下载链接，不显示文件名
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.textContent = '点击下载';
                    a.className = 'file-link';
                    a.target = '_blank';
                    div.appendChild(a);
                }
                messagesDiv.appendChild(div);
            });
            scrollToBottom();
        }

        async function uploadFile(file) {
            const ext = file.name.split('.').pop();
            const filename = Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '.' + ext;
            const path = `${FILES_FOLDER}/${filename}`;
            const url = `https://api.github.com/repos/${REPO}/contents/${path}`;

            const reader = new FileReader();
            const base64 = await new Promise(resolve => {
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
                reader.onerror = () => reject(reader.error);
            });

            const res = await fetch(url, {
                method: 'PUT',
                headers: {'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json'},
                body: JSON.stringify({
                    message: `upload ${filename}`,
                    content: base64,
                    branch: BRANCH
                })
            });

            if (!res.ok) throw new Error('上传失败');
            return {
                filename: file.name,
                url: `https://raw.githubusercontent.com/${REPO}/${BRANCH}/${path}`,
                rawPath: path
            };
        }

        async function addToHistory(entry) {
            const getRes = await fetch(HISTORY_API, {headers: {'Authorization': `token ${GITHUB_TOKEN}`}});
            let history = [], sha = null;
            if (getRes.ok) {
                const data = await getRes.json();
                history = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                sha = data.sha;
            }

            history.push({
                role: currentRole,
                time: new Date().toISOString(),
                ...entry
            });

            await fetch(HISTORY_API, {
                method: 'PUT',
                headers: {'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json'},
                body: JSON.stringify({
                    message: 'new message',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(history)))),
                    sha: sha,
                    branch: BRANCH
                })
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                const div = document.createElement('div');
                div.classList.add('message', 'sent');
                div.textContent = text;
                messagesDiv.appendChild(div);
                scrollToBottom();
                await addToHistory({type: 'text', content: text});
                messageInput.value = '';
                statusDiv.textContent = '已同步';
            }
        }

        async function sendFiles() {
            const files = fileInput.files;
            if (files.length === 0) return;

            statusDiv.textContent = '正在上传附件...';
            for (let file of files) {
                try {
                    const uploaded = await uploadFile(file);
                    const type = file.type.startsWith('image/') ? 'image' : 
                                 file.type.startsWith('video/') ? 'video' : 'file';

                    await addToHistory({
                        type: type,
                        content: uploaded.url,
                        filename: uploaded.filename,
                        url: uploaded.url
                    });

                    // 本地预览
                    const div = document.createElement('div');
                    div.classList.add('message', 'sent');

                    if (type === 'image') {
                        const img = document.createElement('img');
                        img.src = uploaded.url;
                        img.className = 'media-img';
                        addImageClickListener(img);
                        div.appendChild(img);
                    } else if (type === 'video') {
                        const video = document.createElement('video');
                        video.src = uploaded.url;
                        video.controls = true;
                        video.className = 'media-video';
                        div.appendChild(video);
                    } else {
                        // 文件只显示下载链接
                        const a = document.createElement('a');
                        a.href = uploaded.url;
                        a.textContent = '点击下载';
                        a.className = 'file-link';
                        a.target = '_blank';
                        div.appendChild(a);
                    }
                    messagesDiv.appendChild(div);
                    scrollToBottom();
                } catch (e) {
                    statusDiv.textContent = '附件上传失败';
                    console.error(e);
                }
            }
            statusDiv.textContent = '已同步';
            fileInput.value = '';
        }

        function selectRole(role) {
            currentRole = role;
            header.textContent = role === '弟弟' ? '哥哥' : '弟弟';
            roleSelection.style.display = 'none';
            chatContainer.style.display = 'flex';
            loadMessages();
        }

        // 事件绑定
        attachButton.onclick = () => fileInput.click();
        fileInput.onchange = sendFiles;
        sendButton.onclick = sendMessage;
        messageInput.onkeydown = e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        };
        messageInput.onfocus = () => setTimeout(scrollToBottom, 300);

        setInterval(() => { if (currentRole) loadMessages(); }, 30000);
    </script>
</body>
</html>
